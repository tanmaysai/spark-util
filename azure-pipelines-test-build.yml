# Test pipeline for validating Azure DevOps → Docker → ACR flow
# Tests FULL flow including dynamic git repository cloning

trigger: none  # Manual trigger only for testing

parameters:
  - name: gitUrl
    type: string
    displayName: "Git Repository URL"
    default: "https://github.com/your-org/spark-util.git"

  - name: gitBranch
    type: string
    displayName: "Git Branch"
    default: "main"

  - name: gitCommit
    type: string
    displayName: "Git Commit SHA (optional)"
    default: ""

  - name: imageTag
    type: string
    displayName: "Image Tag"
    default: "test-build-$(Build.BuildId)"

variables:
  acrRegistry: 'crescendoimages.azurecr.io'
  acrRepository: 'pyspark-script-runner'
  baseImageTag: 'test9'
  fullImagePath: $(acrRegistry)/$(acrRepository):${{ parameters.imageTag }}

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    displayName: 'Build and Push Test Image'
    jobs:
      - job: BuildImage
        displayName: 'Build Docker Image'
        steps:
          - checkout: none  # Don't checkout pipeline repo

          - script: |
              echo "=== Build Configuration ==="
              echo "Git URL: ${{ parameters.gitUrl }}"
              echo "Git Branch: ${{ parameters.gitBranch }}"
              echo "Git Commit: ${{ parameters.gitCommit }}"
              echo "Image Tag: ${{ parameters.imageTag }}"
              echo "Full Image Path: $(fullImagePath)"
              echo "Base Image: $(acrRegistry)/$(acrRepository):$(baseImageTag)"
            displayName: 'Print Build Configuration'

          - script: |
              # Extract repository name from URL
              REPO_NAME=$(basename "${{ parameters.gitUrl }}" .git)
              echo "Repository name: $REPO_NAME"

              # Clone the repository (publicly accessible for testing)
              # NOTE: For private repos, you'd need to inject a PAT token
              echo "Cloning repository..."
              git clone --depth 1 --branch "${{ parameters.gitBranch }}" "${{ parameters.gitUrl }}" user-repo

              cd user-repo

              # Checkout specific commit if provided
              if [ -n "${{ parameters.gitCommit }}" ]; then
                echo "Fetching specific commit..."
                git fetch origin ${{ parameters.gitCommit }} --depth=1
                git checkout ${{ parameters.gitCommit }}
              fi

              echo ""
              echo "=== Repository cloned successfully ==="
              ls -la
              echo ""

              if [ -f requirements.txt ]; then
                echo "=== requirements.txt ==="
                cat requirements.txt
              else
                echo "No requirements.txt found"
              fi
            displayName: 'Clone Git Repository'

          - script: |
              cd user-repo

              # Generate Dockerfile
              cat > Dockerfile.test << 'DOCKERFILE'
              # Base image with Spark and pre-installed packages
              FROM $(acrRegistry)/$(acrRepository):$(baseImageTag)

              # Copy repository into image
              COPY . /opt/spark/work-dir/repo/

              # Install requirements if present
              RUN if [ -f /opt/spark/work-dir/repo/requirements.txt ]; then \
                      echo "Installing requirements from requirements.txt..."; \
                      python3 -m pip install --no-cache-dir -r /opt/spark/work-dir/repo/requirements.txt; \
                  else \
                      echo "No requirements.txt found, skipping pip install"; \
                  fi

              # Set PYTHONPATH for module imports from repository
              ENV PYTHONPATH=/opt/spark/work-dir/repo:$PYTHONPATH

              # Keep working directory
              WORKDIR /opt/spark/work-dir

              # Default command
              CMD ["/bin/bash"]
              DOCKERFILE

              echo "=== Generated Dockerfile ==="
              cat Dockerfile.test
            displayName: 'Generate Dockerfile'

          - task: Docker@2
            displayName: 'Build and Push Docker Image'
            inputs:
              containerRegistry: 'crescendoimages-acr'  # Service connection name
              repository: '$(acrRepository)'
              command: 'buildAndPush'
              Dockerfile: 'user-repo/Dockerfile.test'
              buildContext: 'user-repo'
              tags: |
                ${{ parameters.imageTag }}
              arguments: '--platform linux/amd64'

          - script: |
              echo ""
              echo "=== ✅ Build Summary ==="
              echo "Image built and pushed successfully!"
              echo "Image: $(fullImagePath)"
              echo "Tag: ${{ parameters.imageTag }}"
              echo ""
              echo "To test this image:"
              echo "  docker pull $(fullImagePath)"
              echo ""
              echo "Built from:"
              echo "  Repository: ${{ parameters.gitUrl }}"
              echo "  Branch: ${{ parameters.gitBranch }}"
              if [ -n "${{ parameters.gitCommit }}" ]; then
                echo "  Commit: ${{ parameters.gitCommit }}"
              fi
            displayName: 'Build Summary'
